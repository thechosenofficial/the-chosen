<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Chosen | Manager Sanctum</title>
    <style>
        body { background-color: #111; color: #ddd; font-family: monospace; padding: 20px; margin: 0; }
        
        /* üîí Ïû†Í∏à ÌôîÎ©¥ */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #adminInput {
            background: #111; border: 1px solid #333; color: #A5C9E1;
            padding: 15px; font-size: 20px; text-align: center; letter-spacing: 5px;
            border-radius: 10px; width: 300px; outline: none;
        }
        .lock-msg { margin-bottom: 20px; color: #555; font-size: 14px; }
        #dashboardContent { display: none; }

        /* UI Ïä§ÌÉÄÏùº */
        h1 { color: #A5C9E1; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #666; padding: 10px 20px; font-size: 16px; cursor: pointer; font-family: monospace; font-weight: bold; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: #A5C9E1; border-bottom: 2px solid #A5C9E1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ÎåÄÏãúÎ≥¥Îìú Î†àÏù¥ÏïÑÏõÉ */
        .dashboard { display: flex; gap: 20px; height: 80vh; }
        .list-panel { width: 300px; overflow-y: auto; border-right: 1px solid #333; padding-right: 10px; }
        .detail-panel { flex: 1; padding-left: 20px; overflow-y: auto; position: relative; }

        /* Î¶¨Ïä§Ìä∏ ÏïÑÏù¥ÌÖú */
        .request-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; }
        .request-item:hover { background-color: #222; color: #fff; }
        .request-item.active { background-color: #A5C9E1; color: #000; }
        
        .badge { font-size: 10px; padding: 2px 5px; border-radius: 4px; }
        .badge.pending { background: #ff6b6b; color: #fff; }
        .badge.granted { background: #51cf66; color: #fff; }
        
        .info-row { margin-bottom: 15px; }
        .label { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
        .value { font-size: 16px; white-space: pre-wrap; line-height: 1.5; color: #fff; }
        .box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }

        /* ‚ú® ÏßÄÍ∞ë Ï£ºÏÜå Ïä§ÌÉÄÏùº */
        .wallet-box {
            border: 1px solid #A5C9E1; background: rgba(165, 201, 225, 0.1);
            padding: 15px; margin-bottom: 20px; border-radius: 8px;
            cursor: pointer; transition: 0.2s;
        }
        .wallet-box:hover { background: rgba(165, 201, 225, 0.2); }
        .wallet-box:active { transform: scale(0.98); }

        /* ‚ú® Í≤ÄÏ¶ù Ï≤¥ÌÅ¨Î∞ïÏä§ ÏòÅÏó≠ */
        .verify-section {
            background: #191919; padding: 15px; border-radius: 8px; margin-top: 20px;
            border: 1px solid #333;
        }
        .verify-label { color: #A5C9E1; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: #A5C9E1; cursor: pointer; }

        textarea, input[type="text"], input[type="date"] { 
            width: 100%; background: #000; color: #A5C9E1; 
            border: 1px solid #555; padding: 10px; font-size: 16px; 
            font-family: monospace; outline: none; box-sizing: border-box;
        }
        textarea { height: 150px; resize: vertical; }
        .write-textarea { height: 400px; font-size: 16px; line-height: 1.6; }

        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        
        /* Grant Î≤ÑÌäº: ÎπÑÌôúÏÑ±/ÌôúÏÑ± ÏÉÅÌÉú */
        .btn-grant { background: #333; color: #777; margin-top: 10px; pointer-events: none; width: 100%; }
        .btn-grant.active { background: #A5C9E1; color: #000; pointer-events: auto; }
        .btn-grant.active:hover { background: #fff; box-shadow: 0 0 15px #A5C9E1; }

        .btn-del { background: #ff6b6b; color: #fff; float: right; margin-top: 10px; }
        .btn-new { background: #333; color: #fff; margin-bottom: 15px; width: 100%; }
        .btn-download { background: #333; color: #fff; font-size: 12px; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="lock-msg">RESTRICTED AREA: ZERO ONLY</div>
        <input type="password" id="adminInput" placeholder="ACCESS CODE" onkeypress="if(event.keyCode==13) checkAdmin()">
    </div>

    <div id="dashboardContent">
        <h1>
            Manager Sanctum
            <button class="btn-download" onclick="downloadCSV()">üì• Address CSV</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('oracle')">Oracle Requests</button>
            <button class="tab-btn" onclick="switchTab('write')">Manage Insights (Eye)</button>
        </div>

        <div id="tab-oracle" class="tab-content active">
            <div class="dashboard">
                <div class="list-panel" id="requestList"><div>Loading...</div></div>
                <div class="detail-panel" id="detailPanel" style="display:none;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="label">Current Status</span>
                        <div id="d-no" style="font-size: 24px; color: #A5C9E1; font-weight: bold;">No. ????</div>
                    </div>

                    <div class="wallet-box" onclick="copyWallet()" title="Click to Copy">
                        <span class="label" style="color: #A5C9E1; margin-bottom: 5px;">üí≥ Wallet Address (Click to Copy)</span>
                        <div id="d-wallet" style="font-size: 16px; word-break: break-all; color: #fff;"></div>
                    </div>

                    <div class="info-row"><span class="label">Basic Info</span><div class="value" id="d-basic"></div></div>
                    <div class="info-row"><span class="label">Contact</span><div class="value" id="d-contact"></div></div>
                    <div class="info-row"><span class="label">Address</span><div class="value" id="d-address" style="color:#ffae00;"></div></div>
                    
                    <div class="info-row"><span class="label">Sovereign Task</span><div class="value box" id="d-task"></div></div>
                    <div class="info-row"><span class="label">Vision 2030</span><div class="value box" id="d-vision"></div></div>
                    
                    <hr style="border-color:#333; margin: 30px 0;">
                    
                    <div id="grantSection">
                        <div class="info-row"><span class="label">Oracle Message</span><textarea id="oracleInput" placeholder="Write the prophecy..."></textarea></div>
                        
                        <div class="verify-section">
                            <label class="verify-label">
                                <input type="checkbox" id="verifyCheck" onchange="toggleGrantBtn()"> 
                                ‚úÖ I have verified this Wallet on OpenSea.
                            </label>
                            <button id="btnGrant" class="btn-grant" onclick="grantProphecy()">‚ö° ASSIGN NUMBER & GRANT</button>
                        </div>
                    </div>
                    
                    <div id="grantedInfo" style="display:none; text-align: center; margin-top: 20px; color: #51cf66;">
                        <h3>ALREADY GRANTED</h3>
                        <p>Message updated if you click again.</p>
                        <button class="btn-grant active" onclick="updateMessageOnly()">Update Message Only</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="dashboard">
                <div class="list-panel">
                    <button class="btn-new" onclick="resetPostForm()">+ Write New Post</button>
                    <div id="postListPanel">Loading Posts...</div>
                </div>
                <div class="detail-panel">
                    <div class="info-row"><span class="label">Title</span><input type="text" id="postTitle" placeholder="Title"></div>
                    <div class="info-row"><span class="label">Date</span><input type="date" id="postDate"></div>
                    <div class="info-row"><span class="label">Content</span><textarea id="postContent" class="write-textarea" placeholder="Content..."></textarea></div>
                    
                    <button id="btnSavePost" class="btn-grant active" onclick="savePost()">üíæ SAVE POST</button>
                    <button id="btnDelPost" class="btn-del" onclick="deletePost()" style="display:none;">üóë DELETE</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // ‚ú® runTransaction Ï∂îÍ∞ÄÎê®
        import { getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, setDoc, addDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Od5T6K7YwNBb3dvY5jku3T_ELq_gi7M",
            authDomain: "thechosenoracle-61638.firebaseapp.com",
            projectId: "thechosenoracle-61638",
            storageBucket: "thechosenoracle-61638.firebasestorage.app",
            messagingSenderId: "835239100275",
            appId: "1:835239100275:web:77544f3a191d33e8dd0f06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // üîí Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù
        window.checkAdmin = async function() {
            const input = document.getElementById('adminInput').value.trim().toUpperCase();
            if (input === "CHOSENDLTMDRN") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadRequests(); 
                loadInsightPosts(); 
            } else {
                alert("ACCESS DENIED");
                document.getElementById('adminInput').value = "";
            }
        };

        // ÌÉ≠ Ï†ÑÌôò
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // ==========================
        // üîÆ 1. Oracle Logic
        // ==========================
        let allRequests = [];
        let currentOracleId = null;

        async function loadRequests() {
            const listPanel = document.getElementById('requestList');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "oracle_requests"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            allRequests = [];
            listPanel.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allRequests.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentOracleId ? 'active' : ''}`;
                div.onclick = () => selectRequest(data.id);
                // Î≤àÌò∏Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú, ÏóÜÏúºÎ©¥ 'NEW'
                const noDisplay = data.guardian_id ? `No. ${data.guardian_id}` : `[NEW]`;
                const statusBadge = data.status === 'granted' ? `<span class="badge granted">DONE</span>` : `<span class="badge pending">WAIT</span>`;
                div.innerHTML = `<div><strong>${noDisplay}</strong><div style="font-size:12px; color:#888;">${new Date(data.timestamp).toLocaleDateString()}</div></div>${statusBadge}`;
                listPanel.appendChild(div);
            });
        }

        window.selectRequest = function(id) {
            currentOracleId = id;
            const data = allRequests.find(r => r.id === id);
            if(!data) return;
            document.getElementById('detailPanel').style.display = 'block';
            
            // Î≤àÌò∏ ÌëúÏãú
            document.getElementById('d-no').innerText = data.guardian_id ? `No. ${data.guardian_id}` : `Not Assigned`;
            document.getElementById('d-no').style.color = data.guardian_id ? "#51cf66" : "#A5C9E1";

            // ÏßÄÍ∞ë Î∞è Ï†ïÎ≥¥
            document.getElementById('d-wallet').innerText = data.wallet_address || "No Wallet Info";
            document.getElementById('d-contact').innerText = data.phone || "No Phone";
            
            const addrDisplay = typeof data.address === 'object' ? Object.values(data.address).join(', ') : data.address;
            document.getElementById('d-basic').innerText = `${data.birth_date.year}.${data.birth_date.month}.${data.birth_date.day} / ${data.birth_time} / ${data.nationality}`;
            document.getElementById('d-task').innerText = data.sovereign_task;
            document.getElementById('d-vision').innerText = data.vision_2030;
            document.getElementById('d-address').innerText = addrDisplay;
            document.getElementById('oracleInput').value = data.oracle_message || '';

            // ÏäπÏù∏ ÏÉÅÌÉúÏóê Îî∞Î•∏ UI Ï†úÏñ¥
            if(data.status === 'granted') {
                document.getElementById('grantSection').style.display = 'none';
                document.getElementById('grantedInfo').style.display = 'block';
            } else {
                document.getElementById('grantSection').style.display = 'block';
                document.getElementById('grantedInfo').style.display = 'none';
                // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
                document.getElementById('verifyCheck').checked = false;
                toggleGrantBtn();
            }
            loadRequests(); // Î¶¨Ïä§Ìä∏ ÌïòÏù¥ÎùºÏù¥Ìä∏ Í∞±Ïã†
        }

        // ÏßÄÍ∞ëÏ£ºÏÜå Î≥µÏÇ¨ Í∏∞Îä•
        window.copyWallet = function() {
            const walletText = document.getElementById('d-wallet').innerText;
            if(walletText) {
                navigator.clipboard.writeText(walletText).then(() => {
                    alert("Wallet Address Copied!");
                });
            }
        }

        // Ï≤¥ÌÅ¨Î∞ïÏä§Ïóê Îî∞Îùº Î≤ÑÌäº ÌôúÏÑ±Ìôî
        window.toggleGrantBtn = function() {
            const isChecked = document.getElementById('verifyCheck').checked;
            const btn = document.getElementById('btnGrant');
            if(isChecked) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // üî• ÌïµÏã¨: ÏäπÏù∏ Î∞è Î≤àÌò∏ Î∂ÄÏó¨ (Transaction)
        window.grantProphecy = async function() {
            if(!currentOracleId || !document.getElementById('oracleInput').value) return alert("Write Oracle Message.");
            
            if(!confirm("Are you sure? This will ASSIGN a Guardian Number permanently.")) return;

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Ïπ¥Ïö¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∞ÄÎîîÏñ∏ Ïà´Ïûê)
                    const counterRef = doc(db, "system_settings", "guardian_counter");
                    const counterSnap = await transaction.get(counterRef);
                    
                    let newId = 1;
                    if (counterSnap.exists()) {
                        newId = counterSnap.data().current_count + 1;
                    }

                    // 2. ÌòÑÏû¨ ÏöîÏ≤≠ Î¨∏ÏÑú ÌôïÏù∏ (Ïù¥ÎØ∏ Î≤àÌò∏Í∞Ä ÏûàÎäîÏßÄ Î∞©Ïñ¥)
                    const reqRef = doc(db, "oracle_requests", currentOracleId);
                    const reqSnap = await transaction.get(reqRef);
                    if (reqSnap.data().guardian_id) {
                        throw "Error: This user already has a number.";
                    }

                    // 3. ÏóÖÎç∞Ïù¥Ìä∏ (Ïπ¥Ïö¥ÌÑ∞ Ï¶ùÍ∞Ä + ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î≤àÌò∏ Î∂ÄÏó¨)
                    transaction.set(counterRef, { current_count: newId }, { merge: true });
                    transaction.update(reqRef, {
                        guardian_id: newId,
                        oracle_message: document.getElementById('oracleInput').value,
                        status: 'granted',
                        granted_at: new Date().toISOString()
                    });
                });

                alert("GRANTED. Number Assigned.");
                selectRequest(currentOracleId); // ÌôîÎ©¥ Í∞±Ïã†

            } catch (error) {
                console.error(error);
                alert("Error: " + error);
            }
        }

        // Ïù¥ÎØ∏ ÏäπÏù∏Îêú ÏÇ¨Îûå Î©îÏãúÏßÄÎßå ÏàòÏ†ï
        window.updateMessageOnly = async function() {
            if(!confirm("Update message only?")) return;
            await updateDoc(doc(db, "oracle_requests", currentOracleId), {
                oracle_message: document.getElementById('oracleInput').value
            });
            alert("Message Updated.");
        }

        window.downloadCSV = function() {
            if(allRequests.length === 0) return alert("No data.");
            const sorted = [...allRequests].sort((a, b) => (a.guardian_id || 9999) - (b.guardian_id || 9999));
            let csv = "data:text/csv;charset=utf-8,\uFEFFNo,Wallet,Phone,Nationality,Address,Task,Vision\n";
            sorted.forEach(row => {
                let addrStr = row.address;
                if (typeof row.address === 'object') {
                    addrStr = `${row.address.street}, ${row.address.city}, ${row.address.state}, ${row.address.zip}, ${row.address.country}`;
                }
                const addr = `"${(addrStr || '').replace(/"/g, '""')}"`;
                const task = `"${(row.sovereign_task || '').replace(/"/g, '""')}"`;
                const vision = `"${(row.vision_2030 || '').replace(/"/g, '""')}"`;
                const wallet = row.wallet_address || '';
                const phone = row.phone || '';
                
                csv += `${row.guardian_id || 'Pending'},${wallet},${phone},${row.nationality},${addr},${task},${vision}\n`;
            });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "guardian_list.csv"; link.click();
        }

        // ==========================
        // üëÅÔ∏è 2. Insight (Post) Logic (Í∏∞Ï°¥ ÎèôÏùº)
        // ==========================
        let allPosts = [];
        let currentPostId = null; 

        document.getElementById('postDate').valueAsDate = new Date();

        async function loadInsightPosts() {
            const listPanel = document.getElementById('postListPanel');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "equilibrium_posts"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            allPosts = []; listPanel.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allPosts.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentPostId ? 'active' : ''}`;
                div.onclick = () => selectPost(data.id);
                div.innerHTML = `<div><strong>${data.title}</strong><div style="font-size:12px; color:#888;">${data.date}</div></div>`;
                listPanel.appendChild(div);
            });
        }

        window.selectPost = function(id) {
            currentPostId = id;
            const data = allPosts.find(p => p.id === id);
            document.getElementById('postTitle').value = data.title;
            document.getElementById('postDate').value = data.date;
            document.getElementById('postContent').value = data.content;
            document.getElementById('btnSavePost').innerText = "üîÑ UPDATE POST";
            document.getElementById('btnDelPost').style.display = "block";
            loadInsightPosts();
        }

        window.resetPostForm = function() {
            currentPostId = null;
            document.getElementById('postTitle').value = "";
            document.getElementById('postDate').valueAsDate = new Date();
            document.getElementById('postContent').value = "";
            document.getElementById('btnSavePost').innerText = "üíæ SAVE NEW POST";
            document.getElementById('btnDelPost').style.display = "none";
            loadInsightPosts();
        }

        window.savePost = async function() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            const content = document.getElementById('postContent').value;
            if(!title || !content) return alert("Fill all fields.");
            if(currentPostId) {
                if(confirm("Update this post?")) {
                    await updateDoc(doc(db, "equilibrium_posts", currentPostId), { title, date, content });
                    alert("Updated."); loadInsightPosts();
                }
            } else {
                if(confirm("Upload new post?")) {
                    await addDoc(collection(db, "equilibrium_posts"), { title, date, content, timestamp: new Date().toISOString() });
                    alert("Uploaded."); resetPostForm(); loadInsightPosts();
                }
            }
        }

        window.deletePost = async function() {
            if(!currentPostId) return;
            if(confirm("‚ö†Ô∏è Permanently DELETE this post?")) {
                await deleteDoc(doc(db, "equilibrium_posts", currentPostId));
                alert("Deleted."); resetPostForm(); loadInsightPosts();
            }
        }
    </script>
</body>
</html>
