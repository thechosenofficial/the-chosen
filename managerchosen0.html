<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Chosen | Manager Sanctum</title>
    <style>
        body { background-color: #111; color: #ddd; font-family: monospace; padding: 20px; margin: 0; }
        
        /* ğŸ”’ ì ê¸ˆ í™”ë©´ */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #adminInput {
            background: #111; border: 1px solid #333; color: #A5C9E1;
            padding: 15px; font-size: 20px; text-align: center; letter-spacing: 5px;
            border-radius: 10px; width: 300px; outline: none;
        }
        .lock-msg { margin-bottom: 20px; color: #555; font-size: 14px; }
        #dashboardContent { display: none; }

        /* UI ìŠ¤íƒ€ì¼ */
        h1 { color: #A5C9E1; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #666; padding: 10px 20px; font-size: 16px; cursor: pointer; font-family: monospace; font-weight: bold; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: #A5C9E1; border-bottom: 2px solid #A5C9E1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ */
        .dashboard { display: flex; gap: 20px; height: 80vh; }
        .list-panel { width: 300px; overflow-y: auto; border-right: 1px solid #333; padding-right: 10px; }
        .detail-panel { flex: 1; padding-left: 20px; overflow-y: auto; position: relative; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .request-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; }
        .request-item:hover { background-color: #222; color: #fff; }
        .request-item.active { background-color: #A5C9E1; color: #000; }
        
        /* ë±ƒì§€ ë° í…ìŠ¤íŠ¸ */
        .badge { font-size: 10px; padding: 2px 5px; border-radius: 4px; }
        .badge.pending { background: #ff6b6b; color: #fff; }
        .badge.granted { background: #51cf66; color: #fff; }
        .info-row { margin-bottom: 15px; }
        .label { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
        .value { font-size: 16px; white-space: pre-wrap; line-height: 1.5; color: #fff; }
        .box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }

        /* ì…ë ¥ì°½ */
        textarea, input[type="text"], input[type="date"] { 
            width: 100%; background: #000; color: #A5C9E1; 
            border: 1px solid #555; padding: 10px; font-size: 16px; 
            font-family: monospace; outline: none; box-sizing: border-box;
        }
        textarea { height: 150px; resize: vertical; }
        .write-textarea { height: 400px; font-size: 16px; line-height: 1.6; }

        /* ë²„íŠ¼ */
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-grant { background: #A5C9E1; color: #000; margin-top: 10px; }
        .btn-grant:hover { background: #fff; }
        .btn-del { background: #ff6b6b; color: #fff; float: right; margin-top: 10px; }
        .btn-new { background: #333; color: #fff; margin-bottom: 15px; width: 100%; }
        .btn-new:hover { background: #555; }
        .btn-download { background: #333; color: #fff; font-size: 12px; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="lock-msg">RESTRICTED AREA: ZERO ONLY</div>
        <input type="password" id="adminInput" placeholder="ACCESS CODE" onkeypress="if(event.keyCode==13) checkAdmin()">
    </div>

    <div id="dashboardContent">
        <h1>
            Manager Sanctum
            <button class="btn-download" onclick="downloadCSV()">ğŸ“¥ Address CSV</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('oracle')">Oracle Requests</button>
            <button class="tab-btn" onclick="switchTab('write')">Manage Insights (Eye)</button>
        </div>

        <div id="tab-oracle" class="tab-content active">
            <div class="dashboard">
                <div class="list-panel" id="requestList"><div>Loading...</div></div>
                <div class="detail-panel" id="detailPanel" style="display:none;">
                    <div class="info-row"><span class="label">Guardian No.</span><div class="value" id="d-no" style="font-size: 24px; color: #A5C9E1;"></div></div>
                    <div class="info-row"><span class="label">Basic Info</span><div class="value" id="d-basic"></div></div>
                    <div class="info-row"><span class="label">Sovereign Task</span><div class="value box" id="d-task"></div></div>
                    <div class="info-row"><span class="label">Vision 2030</span><div class="value box" id="d-vision"></div></div>
                    <div class="info-row"><span class="label">Address</span><div class="value" id="d-address" style="color:#ffae00;"></div></div>
                    <hr style="border-color:#333; margin: 30px 0;">
                    <div class="info-row"><span class="label">Oracle Message</span><textarea id="oracleInput" placeholder="Write the prophecy..."></textarea><button class="btn-grant" onclick="grantProphecy()">âš¡ GRANT PROPHECY</button></div>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="dashboard">
                <div class="list-panel">
                    <button class="btn-new" onclick="resetPostForm()">+ Write New Post</button>
                    <div id="postListPanel">Loading Posts...</div>
                </div>
                <div class="detail-panel">
                    <div class="info-row"><span class="label">Title</span><input type="text" id="postTitle" placeholder="Title"></div>
                    <div class="info-row"><span class="label">Date</span><input type="date" id="postDate"></div>
                    <div class="info-row"><span class="label">Content</span><textarea id="postContent" class="write-textarea" placeholder="Content..."></textarea></div>
                    
                    <button id="btnSavePost" class="btn-grant" onclick="savePost()">ğŸ’¾ SAVE POST</button>
                    <button id="btnDelPost" class="btn-del" onclick="deletePost()" style="display:none;">ğŸ—‘ DELETE</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, setDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Od5T6K7YwNBb3dvY5jku3T_ELq_gi7M",
            authDomain: "thechosenoracle-61638.firebaseapp.com",
            projectId: "thechosenoracle-61638",
            storageBucket: "thechosenoracle-61638.firebasestorage.app",
            messagingSenderId: "835239100275",
            appId: "1:835239100275:web:77544f3a191d33e8dd0f06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ğŸ”’ ê´€ë¦¬ì ì¸ì¦
        window.checkAdmin = async function() {
            const input = document.getElementById('adminInput').value.trim().toUpperCase();
            if (input === "CHOSENDLTMDRN") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadRequests(); // ì˜¤ë¼í´ ë¡œë“œ
                loadInsightPosts(); // ê²Œì‹œê¸€ ë¡œë“œ
            } else {
                alert("ACCESS DENIED");
                document.getElementById('adminInput').value = "";
            }
        };

        // íƒ­ ì „í™˜
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // ==========================
        // ğŸ”® 1. Oracle Logic
        // ==========================
        let allRequests = [];
        let currentOracleId = null;

        async function loadRequests() {
            const listPanel = document.getElementById('requestList');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "oracle_requests"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            allRequests = [];
            listPanel.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allRequests.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentOracleId ? 'active' : ''}`;
                div.onclick = () => selectRequest(data.id);
                const statusBadge = data.status === 'granted' ? `<span class="badge granted">DONE</span>` : `<span class="badge pending">WAIT</span>`;
                div.innerHTML = `<div><strong>No. ${data.guardian_id || '?'}</strong><div style="font-size:12px; color:#888;">${new Date(data.timestamp).toLocaleDateString()}</div></div>${statusBadge}`;
                listPanel.appendChild(div);
            });
        }

        window.selectRequest = function(id) {
            currentOracleId = id;
            const data = allRequests.find(r => r.id === id);
            if(!data) return;
            document.getElementById('detailPanel').style.display = 'block';
            document.getElementById('d-no').innerText = `No. ${data.guardian_id || 'Unknown'}`;
            
            const addrDisplay = typeof data.address === 'object' ? Object.values(data.address).join(', ') : data.address;
            
            document.getElementById('d-basic').innerText = `${data.birth_date.year}.${data.birth_date.month}.${data.birth_date.day} / ${data.birth_time} / ${data.nationality}`;
            document.getElementById('d-task').innerText = data.sovereign_task;
            document.getElementById('d-vision').innerText = data.vision_2030;
            document.getElementById('d-address').innerText = addrDisplay;
            document.getElementById('oracleInput').value = data.oracle_message || '';
            loadRequests(); 
        }

        window.grantProphecy = async function() {
            if(!currentOracleId || !document.getElementById('oracleInput').value) return alert("Check Input");
            if(confirm("Grant this prophecy?")) {
                await updateDoc(doc(db, "oracle_requests", currentOracleId), {
                    oracle_message: document.getElementById('oracleInput').value, status: 'granted'
                });
                alert("Granted."); loadRequests();
            }
        }

        window.downloadCSV = function() {
            if(allRequests.length === 0) return alert("No data.");
            const sorted = [...allRequests].sort((a, b) => (a.guardian_id || 0) - (b.guardian_id || 0));
            let csv = "data:text/csv;charset=utf-8,\uFEFFNo,Nationality,Address,Task,Vision\n";
            sorted.forEach(row => {
                let addrStr = row.address;
                if (typeof row.address === 'object') {
                    addrStr = `${row.address.street}, ${row.address.city}, ${row.address.state}, ${row.address.zip}, ${row.address.country}`;
                }
                const addr = `"${(addrStr || '').replace(/"/g, '""')}"`;
                const task = `"${(row.sovereign_task || '').replace(/"/g, '""')}"`;
                const vision = `"${(row.vision_2030 || '').replace(/"/g, '""')}"`;
                csv += `${row.guardian_id},${row.nationality},${addr},${task},${vision}\n`;
            });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "addresses.csv"; link.click();
        }

        // ==========================
        // ğŸ‘ï¸ 2. Insight (Post) Logic
        // ==========================
        let allPosts = [];
        let currentPostId = null; // nullì´ë©´ ìƒˆ ê¸€ ì‘ì„± ëª¨ë“œ

        document.getElementById('postDate').valueAsDate = new Date();

        // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadInsightPosts() {
            const listPanel = document.getElementById('postListPanel');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "equilibrium_posts"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            
            allPosts = [];
            listPanel.innerHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allPosts.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentPostId ? 'active' : ''}`;
                div.onclick = () => selectPost(data.id);
                div.innerHTML = `<div><strong>${data.title}</strong><div style="font-size:12px; color:#888;">${data.date}</div></div>`;
                listPanel.appendChild(div);
            });
        }

        // ê¸€ ì„ íƒ (ìˆ˜ì • ëª¨ë“œ)
        window.selectPost = function(id) {
            currentPostId = id;
            const data = allPosts.find(p => p.id === id);
            
            document.getElementById('postTitle').value = data.title;
            document.getElementById('postDate').value = data.date;
            document.getElementById('postContent').value = data.content;
            
            document.getElementById('btnSavePost').innerText = "ğŸ”„ UPDATE POST";
            document.getElementById('btnDelPost').style.display = "block";
            
            // ë¦¬ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ê°±ì‹ 
            loadInsightPosts();
        }

        // ìƒˆ ê¸€ ì‘ì„± ëª¨ë“œë¡œ ë¦¬ì…‹
        window.resetPostForm = function() {
            currentPostId = null;
            document.getElementById('postTitle').value = "";
            document.getElementById('postDate').valueAsDate = new Date();
            document.getElementById('postContent').value = "";
            
            document.getElementById('btnSavePost').innerText = "ğŸ’¾ SAVE NEW POST";
            document.getElementById('btnDelPost').style.display = "none";
            loadInsightPosts(); // í•˜ì´ë¼ì´íŠ¸ ì œê±°ìš©
        }

        // ê¸€ ì €ì¥ (ì‘ì„± ë˜ëŠ” ìˆ˜ì •)
        window.savePost = async function() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            const content = document.getElementById('postContent').value;

            if(!title || !content) return alert("Fill all fields.");

            if(currentPostId) {
                // ìˆ˜ì •
                if(confirm("Update this post?")) {
                    await updateDoc(doc(db, "equilibrium_posts", currentPostId), {
                        title: title, date: date, content: content
                    });
                    alert("Updated.");
                    loadInsightPosts();
                }
            } else {
                // ìƒˆ ê¸€ ì‘ì„±
                if(confirm("Upload new post?")) {
                    await addDoc(collection(db, "equilibrium_posts"), {
                        title: title, date: date, content: content,
                        timestamp: new Date().toISOString()
                    });
                    alert("Uploaded.");
                    resetPostForm();
                    loadInsightPosts();
                }
            }
        }

        // ê¸€ ì‚­ì œ
        window.deletePost = async function() {
            if(!currentPostId) return;
            if(confirm("âš ï¸ Permanently DELETE this post?")) {
                await deleteDoc(doc(db, "equilibrium_posts", currentPostId));
                alert("Deleted.");
                resetPostForm();
                loadInsightPosts();
            }
        }

    </script>
</body>
</html>
