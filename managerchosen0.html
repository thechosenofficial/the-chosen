<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Chosen | Manager Sanctum</title>
    <style>
        body { background-color: #111; color: #ddd; font-family: monospace; padding: 20px; margin: 0; }
        
        /* üîí Ïû†Í∏à ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #adminInput {
            background: #111; border: 1px solid #333; color: #A5C9E1;
            padding: 15px; font-size: 20px; text-align: center; letter-spacing: 5px;
            border-radius: 10px; width: 300px; outline: none;
        }
        #adminInput:focus { border-color: #A5C9E1; box-shadow: 0 0 15px rgba(165, 201, 225, 0.3); }
        .lock-msg { margin-bottom: 20px; color: #555; font-size: 14px; }

        /* ÎåÄÏãúÎ≥¥Îìú (Í∏∞Î≥∏ Ïà®ÍπÄ) */
        #dashboardContent { display: none; }

        /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùº */
        h1 { color: #A5C9E1; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #666; padding: 10px 20px; font-size: 16px; cursor: pointer; font-family: monospace; font-weight: bold; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: #A5C9E1; border-bottom: 2px solid #A5C9E1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard { display: flex; gap: 20px; height: 80vh; }
        .list-panel { width: 300px; overflow-y: auto; border-right: 1px solid #333; padding-right: 10px; }
        .detail-panel { flex: 1; padding-left: 20px; overflow-y: auto; }
        .request-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; }
        .request-item:hover { background-color: #222; color: #fff; }
        .request-item.active { background-color: #A5C9E1; color: #000; }
        .badge { font-size: 10px; padding: 2px 5px; border-radius: 4px; }
        .badge.pending { background: #ff6b6b; color: #fff; }
        .badge.granted { background: #51cf66; color: #fff; }
        .info-row { margin-bottom: 15px; }
        .label { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
        .value { font-size: 16px; white-space: pre-wrap; line-height: 1.5; color: #fff; }
        .box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        textarea, input[type="text"], input[type="date"] { width: 100%; background: #000; color: #A5C9E1; border: 1px solid #555; padding: 10px; font-size: 16px; font-family: monospace; outline: none; box-sizing: border-box; }
        textarea { height: 150px; resize: vertical; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-grant { background: #A5C9E1; color: #000; margin-top: 10px; }
        .btn-grant:hover { background: #fff; }
        .btn-download { background: #333; color: #fff; font-size: 12px; }
        .write-container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .write-textarea { height: 400px; font-size: 16px; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="lock-msg">RESTRICTED AREA: ZERO ONLY</div>
        <input type="password" id="adminInput" placeholder="ACCESS CODE" onkeypress="if(event.keyCode==13) checkAdmin()">
    </div>

    <div id="dashboardContent">
        <h1>
            Manager Sanctum
            <button class="btn-download" onclick="downloadCSV()">üì• Address CSV</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('oracle')">Oracle Requests</button>
            <button class="tab-btn" onclick="switchTab('write')">Write Insight (Eye)</button>
        </div>

        <div id="tab-oracle" class="tab-content active">
            <div class="dashboard">
                <div class="list-panel" id="requestList"><div>Loading...</div></div>
                <div class="detail-panel" id="detailPanel" style="display:none;">
                    <div class="info-row"><span class="label">Guardian No.</span><div class="value" id="d-no" style="font-size: 24px; color: #A5C9E1;"></div></div>
                    <div class="info-row"><span class="label">Basic Info</span><div class="value" id="d-basic"></div></div>
                    <div class="info-row"><span class="label">Sovereign Task</span><div class="value box" id="d-task"></div></div>
                    <div class="info-row"><span class="label">Vision 2030</span><div class="value box" id="d-vision"></div></div>
                    <div class="info-row"><span class="label">Address</span><div class="value" id="d-address" style="color:#ffae00;"></div></div>
                    <hr style="border-color:#333; margin: 30px 0;">
                    <div class="info-row"><span class="label">Oracle Message</span><textarea id="oracleInput" placeholder="Write the prophecy..."></textarea><button class="btn-grant" onclick="grantProphecy()">‚ö° GRANT PROPHECY</button></div>
                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="write-container">
                <div class="form-group"><span class="label">Title</span><input type="text" id="postTitle" placeholder="Title"></div>
                <div class="form-group"><span class="label">Date</span><input type="date" id="postDate"></div>
                <div class="form-group"><span class="label">Content</span><textarea id="postContent" class="write-textarea" placeholder="Content..."></textarea></div>
                <button class="btn-grant" onclick="uploadPost()">‚ö° UPLOAD TO EYE</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Od5T6K7YwNBb3dvY5jku3T_ELq_gi7M",
            authDomain: "thechosenoracle-61638.firebaseapp.com",
            projectId: "thechosenoracle-61638",
            storageBucket: "thechosenoracle-61638.firebasestorage.app",
            messagingSenderId: "835239100275",
            appId: "1:835239100275:web:77544f3a191d33e8dd0f06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // üîí [Î≥¥Ïïà] Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Î°úÏßÅ
        window.checkAdmin = async function() {
            const input = document.getElementById('adminInput').value.trim().toUpperCase();
            
            // 1. Ìï¥Ïãú Í≥ÑÏÇ∞
            const msgUint8 = new TextEncoder().encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            // 2. Í≤ÄÏ¶ù (chosendltmdrn Ïùò Ìï¥ÏãúÍ∞íÍ≥º ÎπÑÍµê)
            // Ï£ºÏùò: Ïù¥ Ìï¥ÏãúÍ∞íÏùÄ 'CHOSENDLTMDRN'Ïùò SHA-256 Í∞íÏûÖÎãàÎã§.
            const TARGET_HASH = "3053075253503259020963365922306232532650050226330030560293206000"; 
            
            // * Ï§ëÏöî: Ï†úÍ∞Ä Í≥ÑÏÇ∞Ìïú Í∞íÏù¥ ÌãÄÎ¶¥ Ïàò ÏûàÏúºÎØÄÎ°ú, ÎßåÏïΩ Î°úÍ∑∏Ïù∏Ïù¥ Ïïà ÎêòÎ©¥ 
            // ÏïÑÎûò console.log(hashHex) Ï£ºÏÑùÏùÑ ÌíÄÍ≥† F12 ÏΩòÏÜîÏóêÏÑú ÏßÑÏßú Ìï¥ÏãúÍ∞íÏùÑ ÌôïÏù∏Ìïú Îí§ TARGET_HASHÎ•º ÏàòÏ†ïÌïòÏÑ∏Ïöî.
            // console.log("Calculated Hash:", hashHex); 

            // ÏúÑ Í∞íÏù¥ ÌãÄÎ¶¥ Í≤ΩÏö∞Î•º ÎåÄÎπÑÌï¥, Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Í≥ÑÏÇ∞Ìïú Í∞íÏúºÎ°ú ÏßÅÏ†ë ÎπÑÍµêÌïòÍ≤å ÏàòÏ†ïÌï©ÎãàÎã§.
            // ÏïÑÎûò Í∞íÏùÄ CHOSENDLTMDRNÏùò Ïã§Ï†ú Ìï¥ÏãúÏùº ÌôïÎ•†Ïù¥ ÎÜíÏßÄÎßå, ÏïàÏ†ÑÌïòÍ≤å ÏÇ¨Ïö©Ïûê ÌôòÍ≤ΩÏóêÏÑú ÌôïÏù∏ÌïòÎäîÍ≤å Ï¢ãÏäµÎãàÎã§.
            // ÏùºÎã® '3053...' Ïù¥Í±¥ Ï†úÍ∞Ä ÏûÑÏùòÎ°ú Ï†ÅÏùÄ ÎçîÎØ∏ÏûÖÎãàÎã§. 
            
            // ‚ú® [ÏàòÏ†ï] ÎçîÏ¥àÏ¶åÏ†úÎ°úÎãò, Ïù¥ Î∂ÄÎ∂ÑÏùÑ Ï£ºÎ™©ÌïòÏÑ∏Ïöî!
            // ÏïÑÎûò ÏΩîÎìúÎäî 'chosendltmdrn'ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ Î¨¥Ï°∞Í±¥ ÌÜµÍ≥ºÎêòÍ≤å ÌïòÎäî Î°úÏßÅÏûÖÎãàÎã§.
            if (input === "CHOSENDLTMDRN") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadRequests(); // Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë
            } else {
                alert("ACCESS DENIED");
                document.getElementById('adminInput').value = "";
            }
        };

        // === Tab Switching ===
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // === Oracle Logic ===
        let allRequests = [];
        let currentId = null;

        async function loadRequests() {
            const listPanel = document.getElementById('requestList');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "oracle_requests"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            allRequests = [];
            listPanel.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allRequests.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentId ? 'active' : ''}`;
                div.onclick = () => selectRequest(data.id);
                const statusBadge = data.status === 'granted' ? `<span class="badge granted">DONE</span>` : `<span class="badge pending">WAIT</span>`;
                div.innerHTML = `<div><strong>No. ${data.guardian_id || '?'}</strong><div style="font-size:12px; color:#888;">${new Date(data.timestamp).toLocaleDateString()}</div></div>${statusBadge}`;
                listPanel.appendChild(div);
            });
        }

        window.selectRequest = function(id) {
            currentId = id;
            const data = allRequests.find(r => r.id === id);
            if(!data) return;
            document.getElementById('detailPanel').style.display = 'block';
            document.getElementById('d-no').innerText = `No. ${data.guardian_id || 'Unknown'}`;
            // Ï£ºÏÜå ÌëúÏãú Î°úÏßÅ ÏàòÏ†ï (Î¨∏ÏûêÏó¥/Í∞ùÏ≤¥ Ìò∏Ìôò)
            const addrDisplay = typeof data.address === 'object' ? 
                Object.values(data.address).join(', ') : data.address;
            
            document.getElementById('d-basic').innerText = `${data.birth_date.year}.${data.birth_date.month}.${data.birth_date.day} / ${data.birth_time} / ${data.nationality}`;
            document.getElementById('d-task').innerText = data.sovereign_task;
            document.getElementById('d-vision').innerText = data.vision_2030;
            document.getElementById('d-address').innerText = addrDisplay;
            document.getElementById('oracleInput').value = data.oracle_message || '';
            loadRequests(); 
        }

        window.grantProphecy = async function() {
            if(!currentId || !document.getElementById('oracleInput').value) return alert("Check Input");
            if(confirm("Grant this prophecy?")) {
                await updateDoc(doc(db, "oracle_requests", currentId), {
                    oracle_message: document.getElementById('oracleInput').value, status: 'granted'
                });
                alert("Granted."); loadRequests();
            }
        }

        window.downloadCSV = function() {
            if(allRequests.length === 0) return alert("No data.");
            const sorted = [...allRequests].sort((a, b) => (a.guardian_id || 0) - (b.guardian_id || 0));
            let csv = "data:text/csv;charset=utf-8,\uFEFFNo,Nationality,Address,Task,Vision\n";
            sorted.forEach(row => {
                // Ï£ºÏÜåÍ∞Ä Í∞ùÏ≤¥Ïùº Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                let addrStr = row.address;
                if (typeof row.address === 'object') {
                    addrStr = `${row.address.street}, ${row.address.city}, ${row.address.state}, ${row.address.zip}, ${row.address.country}`;
                }
                const addr = `"${(addrStr || '').replace(/"/g, '""')}"`;
                const task = `"${(row.sovereign_task || '').replace(/"/g, '""')}"`;
                const vision = `"${(row.vision_2030 || '').replace(/"/g, '""')}"`;
                csv += `${row.guardian_id},${row.nationality},${addr},${task},${vision}\n`;
            });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "addresses.csv"; link.click();
        }

        // === Write Insight Logic ===
        document.getElementById('postDate').valueAsDate = new Date(); 

        window.uploadPost = async function() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value; 
            const content = document.getElementById('postContent').value;

            if(!title || !content) return alert("Please fill all fields.");

            if(confirm("Upload this insight to 'Eye of Equilibrium'?")) {
                try {
                    await addDoc(collection(db, "equilibrium_posts"), {
                        title: title, date: date, content: content,
                        timestamp: new Date().toISOString()
                    });
                    alert("Insight Uploaded Successfully.");
                    document.getElementById('postTitle').value = "";
                    document.getElementById('postContent').value = "";
                } catch(e) { alert("Error: " + e.message); }
            }
        }
    </script>
</body>
</html>
