<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Chosen | Manager Sanctum</title>
    <style>
        /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ */
        body { background-color: #111; color: #ddd; font-family: monospace; padding: 20px; margin: 0; }
        
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #adminInput {
            background: #111; border: 1px solid #333; color: #A5C9E1;
            padding: 15px; font-size: 20px; text-align: center; letter-spacing: 5px;
            border-radius: 10px; width: 300px; outline: none;
        }
        #dashboardContent { display: none; }

        h1 { color: #A5C9E1; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tabs { margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #666; padding: 10px 20px; font-size: 16px; cursor: pointer; font-family: monospace; font-weight: bold; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: #A5C9E1; border-bottom: 2px solid #A5C9E1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .dashboard { display: flex; gap: 20px; height: 80vh; }
        .list-panel { width: 300px; overflow-y: auto; border-right: 1px solid #333; padding-right: 10px; }
        .detail-panel { flex: 1; padding-left: 20px; overflow-y: auto; position: relative; }

        /* Î¶¨Ïä§Ìä∏ ÏïÑÏù¥ÌÖú */
        .request-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; }
        .request-item:hover { background-color: #222; color: #fff; }
        .request-item.active { background-color: #A5C9E1; color: #000; }
        
        .badge { font-size: 10px; padding: 2px 5px; border-radius: 4px; }
        .badge.pending { background: #ff6b6b; color: #fff; } /* ÎåÄÍ∏∞ */
        .badge.new { background: #ffae00; color: #000; } /* Ïã†Í∑ú Ïã†Ï≤≠ */
        
        .wallet-box {
            border: 1px solid #A5C9E1; background: rgba(165, 201, 225, 0.1);
            padding: 15px; margin-bottom: 20px; border-radius: 8px; cursor: pointer;
        }
        .info-row { margin-bottom: 15px; }
        .label { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
        .value { font-size: 16px; white-space: pre-wrap; line-height: 1.5; color: #fff; }
        .box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }

        /* Î≤ÑÌäº */
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-grant { background: #333; color: #777; margin-top: 10px; pointer-events: none; width: 100%; }
        .btn-grant.active { background: #A5C9E1; color: #000; pointer-events: auto; }
        .btn-reject { background: #333; color: #ff6b6b; border: 1px solid #ff6b6b; margin-top: 10px; width: 100%; font-size: 12px; }
        .btn-reject:hover { background: #ff6b6b; color: #000; }
        .btn-download { background: #333; color: #fff; font-size: 12px; }

        /* ÏûÖÎ†•Ï∞Ω */
        textarea, input[type="text"], input[type="date"] { 
            width: 100%; background: #000; color: #A5C9E1; 
            border: 1px solid #555; padding: 10px; font-size: 16px; font-family: monospace; outline: none; box-sizing: border-box;
        }
        textarea { height: 150px; resize: vertical; }
        .write-textarea { height: 400px; font-size: 16px; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="lock-msg">RESTRICTED AREA: ZERO ONLY</div>
        <input type="password" id="adminInput" placeholder="ACCESS CODE" onkeypress="if(event.keyCode==13) checkAdmin()">
    </div>

    <div id="dashboardContent">
        <h1>
            Manager Sanctum
            <button class="btn-download" onclick="downloadCSV()">üì• Address CSV</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('gate')">Gate of Gnosis (Entry)</button>
            <button class="tab-btn" onclick="switchTab('oracle')">Oracle Altar (Prophecy)</button>
            <button class="tab-btn" onclick="switchTab('write')">Equilibrium Eye</button>
        </div>

        <div id="tab-gate" class="tab-content active">
            <div class="dashboard">
                <div class="list-panel" id="gateList"><div>Loading...</div></div>
                <div class="detail-panel" id="gateDetail" style="display:none;">
                    
                    <div style="margin-bottom: 20px;">
                        <span class="label">Entry Request</span>
                        <div class="wallet-box" onclick="copyText('g-wallet')" title="Click to Copy">
                            <span class="label" style="color: #A5C9E1;">üí≥ Wallet Address</span>
                            <div id="g-wallet" style="font-size: 16px; word-break: break-all; color: #fff;"></div>
                        </div>
                        <div class="info-row"><span class="label">Requested At</span><div class="value" id="g-date"></div></div>
                    </div>

                    <hr style="border-color:#333; margin: 30px 0;">

                    <div style="background: #191919; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                        <label style="color: #A5C9E1; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="gateVerifyCheck" onchange="toggleGateBtn()"> 
                            ‚úÖ I have verified this Wallet on OpenSea.
                        </label>
                        <button id="btnEntryApprove" class="btn-grant" onclick="approveEntry()">‚ö° ASSIGN NUMBER & OPEN GATE</button>
                        <button class="btn-reject" onclick="rejectEntry()">‚õî REJECT (Non-Holder)</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="tab-oracle" class="tab-content">
            <div class="dashboard">
                <div class="list-panel" id="oracleList"><div>Loading...</div></div>
                <div class="detail-panel" id="oracleDetail" style="display:none;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="label">Guardian Status</span>
                        <div id="o-no" style="font-size: 24px; color: #51cf66; font-weight: bold;">No. ????</div>
                    </div>

                    <div class="info-row"><span class="label">Basic Info</span><div class="value" id="o-basic"></div></div>
                    
                    <div class="info-row"><span class="label">Contact (Phone)</span><div class="value" id="o-phone"></div></div>
                    <div class="info-row"><span class="label">Address (Final)</span><div class="value" id="o-address" style="color:#ffae00;"></div></div>
                    
                    <div class="info-row"><span class="label">Sovereign Task</span><div class="value box" id="o-task"></div></div>
                    <div class="info-row"><span class="label">Vision 2030</span><div class="value box" id="o-vision"></div></div>
                    
                    <hr style="border-color:#333; margin: 30px 0;">
                    
                    <div class="info-row"><span class="label">Oracle Message</span><textarea id="oracleMsgInput" placeholder="Write the prophecy..."></textarea></div>
                    <button class="btn-grant active" onclick="grantProphecy()">‚ö° GRANT PROPHECY</button>

                </div>
            </div>
        </div>

        <div id="tab-write" class="tab-content">
            <div class="dashboard">
                <div class="list-panel">
                    <button class="btn-new" onclick="resetPostForm()" style="background:#333; width:100%; color:#fff; margin-bottom:10px;">+ Write New Post</button>
                    <div id="postListPanel">Loading Posts...</div>
                </div>
                <div class="detail-panel">
                    <div class="info-row"><span class="label">Title</span><input type="text" id="postTitle" placeholder="Title"></div>
                    <div class="info-row"><span class="label">Date</span><input type="date" id="postDate"></div>
                    <div class="info-row"><span class="label">Image URL (Optional)</span><input type="text" id="postImage" placeholder="https://..."></div>
                    <div class="info-row"><span class="label">Content</span><textarea id="postContent" class="write-textarea" placeholder="Content..."></textarea></div>
                    
                    <button id="btnSavePost" class="btn-grant active" onclick="savePost()">üíæ SAVE POST</button>
                    <button id="btnDelPost" class="btn-reject" onclick="deletePost()" style="display:none; width:auto; float:right;">üóë DELETE</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, orderBy, setDoc, addDoc, deleteDoc, runTransaction, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Od5T6K7YwNBb3dvY5jku3T_ELq_gi7M",
            authDomain: "thechosenoracle-61638.firebaseapp.com",
            projectId: "thechosenoracle-61638",
            storageBucket: "thechosenoracle-61638.firebasestorage.app",
            messagingSenderId: "835239100275",
            appId: "1:835239100275:web:77544f3a191d33e8dd0f06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // üîí Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù
        window.checkAdmin = function() {
            const input = document.getElementById('adminInput').value.trim().toUpperCase();
            if (input === "CHOSENDLTMDRN") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadGateList(); 
                loadOracleList(); 
                loadInsightPosts(); 
            } else {
                alert("ACCESS DENIED");
                document.getElementById('adminInput').value = "";
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        window.copyText = function(id) {
            const txt = document.getElementById(id).innerText;
            if(txt) navigator.clipboard.writeText(txt).then(() => alert("Copied!"));
        }

        // ==========================
        // üö™ Tab 1: Gate of Gnosis (Entry)
        // ==========================
        let gateRequests = [];
        let currentGateId = null;

        async function loadGateList() {
            const listPanel = document.getElementById('gateList');
            listPanel.innerHTML = 'Loading...';
            // pending_entry ÏÉÅÌÉúÏù∏ Í≤ÉÎßå Î∂àÎü¨Ïò¥
            const q = query(collection(db, "oracle_requests"), where("status", "==", "pending_entry"));
            const snapshot = await getDocs(q);
            gateRequests = [];
            listPanel.innerHTML = '';
            
            if(snapshot.empty) { listPanel.innerHTML = '<div style="padding:10px; color:#666;">No Pending Requests</div>'; return; }

            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; gateRequests.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentGateId ? 'active' : ''}`;
                div.onclick = () => selectGateRequest(data.id);
                // ÏßÄÍ∞ë Ï£ºÏÜå ÏïûÎí§Îßå Î≥¥Ïó¨Ï£ºÍ∏∞
                const shortWallet = data.wallet_address.substring(0,6) + "..." + data.wallet_address.substring(38);
                div.innerHTML = `<div><strong>${shortWallet}</strong><div style="font-size:12px; color:#888;">${new Date(data.entry_requested_at).toLocaleDateString()}</div></div><span class="badge new">NEW</span>`;
                listPanel.appendChild(div);
            });
        }

        window.selectGateRequest = function(id) {
            currentGateId = id;
            const data = gateRequests.find(r => r.id === id);
            document.getElementById('gateDetail').style.display = 'block';
            document.getElementById('g-wallet').innerText = data.wallet_address;
            document.getElementById('g-date').innerText = new Date(data.entry_requested_at).toLocaleString();
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
            document.getElementById('gateVerifyCheck').checked = false;
            toggleGateBtn();
        }

        window.toggleGateBtn = function() {
            const isChecked = document.getElementById('gateVerifyCheck').checked;
            const btn = document.getElementById('btnEntryApprove');
            if(isChecked) btn.classList.add('active'); else btn.classList.remove('active');
        }

        // üî• ÏûÖÏû• ÏäπÏù∏ (Î≤àÌò∏ Î∂ÄÏó¨)
        window.approveEntry = async function() {
            if(!currentGateId) return;
            if(!confirm("Approve Entry & Assign Number?")) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const counterRef = doc(db, "system_settings", "guardian_counter");
                    const counterSnap = await transaction.get(counterRef);
                    let newId = 1;
                    if (counterSnap.exists()) { newId = counterSnap.data().current_count + 1; }
                    
                    const reqRef = doc(db, "oracle_requests", currentGateId);
                    transaction.set(counterRef, { current_count: newId }, { merge: true });
                    transaction.update(reqRef, {
                        guardian_id: newId,
                        status: 'entry_approved', // 1Îã®Í≥Ñ ÌÜµÍ≥º
                        approved_at: new Date().toISOString()
                    });
                });
                alert("Gate Opened. Number Assigned.");
                document.getElementById('gateDetail').style.display = 'none';
                loadGateList(); // Î™©Î°ù Í∞±Ïã†
            } catch (e) { alert("Error: " + e); }
        }

        // ÏûÖÏû• Í±∞Ï†à
        window.rejectEntry = async function() {
            if(!currentGateId) return;
            if(!confirm("Reject this wallet PERMANENTLY?")) return;
            await updateDoc(doc(db, "oracle_requests", currentGateId), { status: 'rejected' });
            alert("Rejected.");
            document.getElementById('gateDetail').style.display = 'none';
            loadGateList();
        }


        // ==========================
        // üîÆ Tab 2: Oracle Altar (Prophecy)
        // ==========================
        let oracleRequests = [];
        let currentOracleId = null;

        async function loadOracleList() {
            const listPanel = document.getElementById('oracleList');
            listPanel.innerHTML = 'Loading...';
            // oracle_submitted (Ìèº Ï†úÏ∂úÎê®) ÏÉÅÌÉúÎßå Î∂àÎü¨Ïò¥ (Ïù¥ÎØ∏ Î≤àÌò∏ ÏûàÏùå)
            const q = query(collection(db, "oracle_requests"), where("status", "==", "oracle_submitted"));
            const snapshot = await getDocs(q);
            oracleRequests = [];
            listPanel.innerHTML = '';

            if(snapshot.empty) { listPanel.innerHTML = '<div style="padding:10px; color:#666;">No Pending Oracles</div>'; return; }

            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; oracleRequests.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentOracleId ? 'active' : ''}`;
                div.onclick = () => selectOracleRequest(data.id);
                div.innerHTML = `<div><strong>No. ${data.guardian_id}</strong><div style="font-size:12px; color:#888;">Submitted</div></div><span class="badge pending">WAIT</span>`;
                listPanel.appendChild(div);
            });
        }

        window.selectOracleRequest = function(id) {
            currentOracleId = id;
            const data = oracleRequests.find(r => r.id === id);
            document.getElementById('oracleDetail').style.display = 'block';
            
            document.getElementById('o-no').innerText = `No. ${String(data.guardian_id).padStart(4,'0')}`;
            document.getElementById('o-basic').innerText = `${data.birth_date.year}.${data.birth_date.month}.${data.birth_date.day} / ${data.birth_time} / ${data.nationality}`;
            document.getElementById('o-phone').innerText = data.phone;
            
            const addrDisplay = typeof data.address === 'object' ? Object.values(data.address).join(', ') : data.address;
            document.getElementById('o-address').innerText = addrDisplay;
            
            document.getElementById('o-task').innerText = data.sovereign_task;
            document.getElementById('o-vision').innerText = data.vision_2030;
            document.getElementById('oracleMsgInput').value = '';
        }

        // Ïã†ÌÉÅ ÌïòÏÇ¨
        window.grantProphecy = async function() {
            if(!currentOracleId || !document.getElementById('oracleMsgInput').value) return alert("Write Oracle Message.");
            if(!confirm("Grant Prophecy?")) return;

            await updateDoc(doc(db, "oracle_requests", currentOracleId), {
                oracle_message: document.getElementById('oracleMsgInput').value,
                status: 'oracle_granted', // 2Îã®Í≥Ñ ÌÜµÍ≥º (ÏµúÏ¢Ö ÏôÑÎ£å)
                granted_at: new Date().toISOString()
            });
            alert("Prophecy Granted.");
            document.getElementById('oracleDetail').style.display = 'none';
            loadOracleList();
        }


        // ==========================
        // üëÅÔ∏è Tab 3: Equilibrium Eye (Write)
        // ==========================
        let allPosts = [];
        let currentPostId = null;
        document.getElementById('postDate').valueAsDate = new Date();

        async function loadInsightPosts() {
            const listPanel = document.getElementById('postListPanel');
            listPanel.innerHTML = 'Loading...';
            const q = query(collection(db, "equilibrium_posts"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            allPosts = []; listPanel.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data(); data.id = doc.id; allPosts.push(data);
                const div = document.createElement('div');
                div.className = `request-item ${data.id === currentPostId ? 'active' : ''}`;
                div.onclick = () => selectPost(data.id);
                div.innerHTML = `<div><strong>${data.title}</strong><div style="font-size:12px; color:#888;">${data.date}</div></div>`;
                listPanel.appendChild(div);
            });
        }

        window.selectPost = function(id) {
            currentPostId = id;
            const data = allPosts.find(p => p.id === id);
            document.getElementById('postTitle').value = data.title;
            document.getElementById('postDate').value = data.date;
            document.getElementById('postImage').value = data.image_url || ""; // Ïù¥ÎØ∏ÏßÄ URL Î∂àÎü¨Ïò§Í∏∞
            document.getElementById('postContent').value = data.content;
            document.getElementById('btnSavePost').innerText = "üîÑ UPDATE POST";
            document.getElementById('btnDelPost').style.display = "block";
            loadInsightPosts();
        }

        window.resetPostForm = function() {
            currentPostId = null;
            document.getElementById('postTitle').value = "";
            document.getElementById('postDate').valueAsDate = new Date();
            document.getElementById('postImage').value = "";
            document.getElementById('postContent').value = "";
            document.getElementById('btnSavePost').innerText = "üíæ SAVE NEW POST";
            document.getElementById('btnDelPost').style.display = "none";
            loadInsightPosts();
        }

        window.savePost = async function() {
            const title = document.getElementById('postTitle').value;
            const date = document.getElementById('postDate').value;
            const image_url = document.getElementById('postImage').value;
            const content = document.getElementById('postContent').value;

            if(!title || !content) return alert("Fill Title & Content.");

            const postData = { title, date, image_url, content };

            if(currentPostId) {
                if(confirm("Update this post?")) {
                    await updateDoc(doc(db, "equilibrium_posts", currentPostId), postData);
                    alert("Updated."); loadInsightPosts();
                }
            } else {
                if(confirm("Upload new post?")) {
                    postData.timestamp = new Date().toISOString();
                    await addDoc(collection(db, "equilibrium_posts"), postData);
                    alert("Uploaded."); resetPostForm(); loadInsightPosts();
                }
            }
        }

        window.deletePost = async function() {
            if(!currentPostId) return;
            if(confirm("‚ö†Ô∏è Permanently DELETE this post?")) {
                await deleteDoc(doc(db, "equilibrium_posts", currentPostId));
                alert("Deleted."); resetPostForm(); loadInsightPosts();
            }
        }

        window.downloadCSV = function() {
            // (CSV Îã§Ïö¥Î°úÎìú Î°úÏßÅÏùÄ ÎÇòÏ§ëÏóê ÌïÑÏöîÌïòÎ©¥ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ï°∞ÌöåÌï¥ÏÑú Íµ¨ÌòÑ)
            alert("CSV download for specific tab not implemented yet.");
        }
    </script>
</body>
</html>
