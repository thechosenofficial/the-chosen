<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Chosen | Oracle</title>
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #131314;
            --card-bg: #1e1f20;
            --border: #333;
            --silver-mid: #A5C9E1;
            --silver-light: #FFFFFF;
            --pure-silver: #D3D3D3;
            --warning: #ff6b6b;
        }

        body {
            background-color: var(--bg-color);
            color: var(--pure-silver);
            font-family: 'Pirata One', system-ui;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .luster-text {
            background: linear-gradient(to bottom, var(--silver-light), var(--silver-mid), var(--silver-light));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .altar-container { width: 100%; max-width: 500px; margin-top: 5vh; position: relative; }

        h2 { font-size: 40px; margin-bottom: 20px; letter-spacing: 2px; }

        /* ‚ú® Í≤ΩÍ≥† Î¨∏Íµ¨ Ïä§ÌÉÄÏùº */
        .warning-text {
            color: var(--warning); font-size: 16px; text-align: center;
            margin-bottom: 30px; letter-spacing: 1px;
            border: 1px solid var(--warning); padding: 10px; border-radius: 8px;
            background: rgba(255, 107, 107, 0.05);
        }

        .oracle-form { display: flex; flex-direction: column; gap: 20px; text-align: left; }
        .field-group { display: flex; flex-direction: column; gap: 8px; }

        .birth-select-wrapper { display: flex; gap: 10px; }
        .birth-select-wrapper select { flex: 1; }

        label { font-size: 16px; color: var(--silver-mid); margin-left: 5px; }

        input, textarea, select {
            background-color: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border);
            border-radius: 12px; padding: 15px; 
            color: var(--pure-silver);
            font-family: 'Pirata One', cursive; font-size: 18px; outline: none;
            transition: 0.3s; width: 100%; box-sizing: border-box;
        }

        input:focus, textarea:focus, select:focus { border-color: var(--silver-mid); background: rgba(255, 255, 255, 0.05); }

        textarea { height: 100px; resize: none; }
        
        .submit-btn {
            background-color: var(--silver-mid); color: var(--bg-color);
            border: none; border-radius: 30px; padding: 18px;
            font-family: 'Pirata One', cursive; font-size: 22px; cursor: pointer;
            transition: 0.4s; margin-top: 20px; width: 100%;
        }
        .submit-btn:hover { background-color: var(--silver-light); transform: translateY(-3px); }

        /* ‚ú® ÏÉÅÌÉúÎ≥Ñ ÏÑπÏÖò (Waiting, Result) */
        .status-section { 
            display: none; /* Í∏∞Î≥∏ Ïà®ÍπÄ */
            text-align: center; 
            border: 1px solid var(--border); 
            padding: 40px 20px; 
            border-radius: 20px; 
            background: var(--card-bg);
            animation: fadeIn 1s;
        }

        .reveal-btn {
            background: transparent; border: 1px solid var(--silver-mid);
            color: var(--silver-mid); padding: 15px 30px; font-size: 20px;
            border-radius: 30px; cursor: pointer; margin-top: 20px;
            font-family: 'Pirata One'; transition: 0.3s;
            animation: pulse 2s infinite;
        }
        .reveal-btn:hover { background: var(--silver-mid); color: #000; box-shadow: 0 0 20px var(--silver-mid); }

        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(165, 201, 225, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(165, 201, 225, 0);} 100% {box-shadow: 0 0 0 0 rgba(165, 201, 225, 0);} }

        /* ‚ú® Ï£ºÏÜå ÏàòÏ†ï ÏÑπÏÖò (ÌïòÎã®) */
        .address-update-box {
            margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;
            display: none; /* ÌïÑÏöîÏãú JSÎ°ú ÌëúÏãú */
        }
        .small-btn {
            background: #333; color: #ccc; border: none; padding: 10px 20px;
            border-radius: 20px; cursor: pointer; font-family: 'Pirata One'; margin-top: 10px;
        }

        /* ‚ú® ÌåùÏóÖ Î™®Îã¨ (Oracle Message) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s;
        }
        .modal-content {
            background: #111; border: 1px solid var(--silver-mid);
            padding: 40px; border-radius: 15px; max-width: 80%; text-align: center;
            box-shadow: 0 0 30px rgba(165, 201, 225, 0.2);
            position: relative;
        }
        .oracle-text {
            font-size: 24px; line-height: 1.6; color: var(--silver-light);
            margin: 20px 0; white-space: pre-wrap;
        }
        .close-modal {
            position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; color: #666;
        }
        .close-modal:hover { color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="altar-container">
        <h2 class="luster-text">The Oracle Altar</h2>

        <div id="formSection">
            <div class="warning-text">
                ‚ö†Ô∏è WARNING: Once offered, your destiny (Birth, Task, Vision) cannot be altered. Only your physical location (Address) remains mutable until 2029.
            </div>

            <form id="oracleForm" class="oracle-form">
                <div class="field-group">
                    <label>Date of Birth</label>
                    <div class="birth-select-wrapper">
                        <select id="birthYear" name="year" required><option value="" disabled selected>Year</option></select>
                        <select id="birthMonth" name="month" required><option value="" disabled selected>Month</option></select>
                        <select id="birthDay" name="day" required><option value="" disabled selected>Day</option></select>
                    </div>
                </div>
                
                <div class="field-group">
                    <label>Time of Birth</label>
                    <select id="birthTime" required>
                        <option value="" disabled selected>Select Time</option>
                        <option value="unknown">Unknown</option>
                        <option value="23:00-00:59">23:00 ~ 00:59 (Rat)</option>
                        <option value="01:00-02:59">01:00 ~ 02:59 (Ox)</option>
                        <option value="03:00-04:59">03:00 ~ 04:59 (Tiger)</option>
                        <option value="05:00-06:59">05:00 ~ 06:59 (Rabbit)</option>
                        <option value="07:00-08:59">07:00 ~ 08:59 (Dragon)</option>
                        <option value="09:00-10:59">09:00 ~ 10:59 (Snake)</option>
                        <option value="11:00-12:59">11:00 ~ 12:59 (Horse)</option>
                        <option value="13:00-14:59">13:00 ~ 14:59 (Sheep)</option>
                        <option value="15:00-16:59">15:00 ~ 16:59 (Monkey)</option>
                        <option value="17:00-18:59">17:00 ~ 18:59 (Rooster)</option>
                        <option value="19:00-20:59">19:00 ~ 20:59 (Dog)</option>
                        <option value="21:00-22:59">21:00 ~ 22:59 (Pig)</option>
                    </select>
                </div>

                <div class="field-group">
                    <label>Nationality</label>
                    <input type="text" id="nationality" placeholder="Your Origin" required>
                </div>

                <div class="field-group">
                    <label>Sovereign Task</label>
                    <textarea id="sovereignTask" placeholder="Describe your purpose in this world..." required></textarea>
                </div>

                <div class="field-group">
                    <label>Vision of 2030</label>
                    <textarea id="vision" maxlength="200" placeholder="I have seen the future..." required></textarea>
                </div>

                <div class="field-group">
                    <label style="color: var(--silver-light);">Physical Address (Mailable)</label>
                    <input type="text" id="address" placeholder="Full address for the Ma-Pae (Postal Code included)" required style="border-color: var(--silver-mid);">
                </div>

                <button type="submit" class="submit-btn">Offer to Equilibrium</button>
            </form>
        </div>

        <div id="waitingSection" class="status-section">
            <h3 class="luster-text">The Offering is Made.</h3>
            <p>Your frequency is being analyzed by the Void.</p>
            <p style="color: var(--silver-mid); margin-top: 20px;">Estimated Waiting Time: Within 7 Days</p>
            <br>
            <p style="font-size: 14px; color: #666;">(You can close this window and return later.)</p>
        </div>

        <div id="grantedSection" class="status-section">
            <h3 class="luster-text" style="font-size: 32px;">The Oracle has Spoken.</h3>
            <p>The Equilibrium has responded to your frequency.</p>
            <button class="reveal-btn" onclick="openModal()">Reveal the Prophecy</button>
        </div>

        <div id="addressUpdateSection" class="address-update-box">
            <label>Update Physical Address (Until Sep. 2029)</label>
            <input type="text" id="updateAddressInput" placeholder="New Address">
            <button class="small-btn" onclick="updateAddress()">Update Address</button>
        </div>
    </div>

    <div id="oracleModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 class="luster-text">Prophecy</h3>
            <div id="oracleContent" class="oracle-text"></div>
            <div style="font-size: 14px; color: #555; margin-top: 30px;">The Chosen Oracle</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Od5T6K7YwNBb3dvY5jku3T_ELq_gi7M",
            authDomain: "thechosenoracle-61638.firebaseapp.com",
            projectId: "thechosenoracle-61638",
            storageBucket: "thechosenoracle-61638.firebasestorage.app",
            messagingSenderId: "835239100275",
            appId: "1:835239100275:web:77544f3a191d33e8dd0f06"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Î¨∏ÏÑú ID (Ìï¥ÏãúÍ∞í) Í∞ÄÏ†∏Ïò§Í∏∞
        const userHash = localStorage.getItem('user_code') ? await digestMessage(localStorage.getItem('user_code')) : null;

        // Ìï¥Ïãú Ìï®Ïàò (Î°úÍ∑∏Ïù∏ ÎïåÏôÄ ÎèôÏùº)
        async function digestMessage(message) {
            const msgUint8 = new TextEncoder().encode(message.toUpperCase()); // ÎåÄÎ¨∏Ïûê ÌÜµÏùº Ï§ëÏöî
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Ï¥àÍ∏∞Ìôî
        window.onload = async function() {
            if (localStorage.getItem('chosen_access') !== 'granted' || !userHash) {
                alert("Unauthorized Access.");
                window.location.replace("index.html");
                return;
            }

            initDateSelects(); // ÎÇ†Ïßú ÎìúÎ°≠Îã§Ïö¥ ÏÉùÏÑ±
            checkOracleStatus(); // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ ÏÉÅÌÉú ÌôïÏù∏
        };

        // üî• ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ ÏÉÅÌÉú Ïã§ÏãúÍ∞Ñ ÌôïÏù∏
        function checkOracleStatus() {
            const docRef = doc(db, "oracle_requests", userHash);

            // Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà (onSnapshot) ÏÇ¨Ïö© -> Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏäπÏù∏ÌïòÎ©¥ Ï¶âÏãú ÌôîÎ©¥ Î∞îÎÄú
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Ïù¥ÎØ∏ Ï†úÏ∂úÌïú Í≤ΩÏö∞ -> Ìèº Ïà®ÍπÄ
                    document.getElementById('formSection').style.display = 'none';
                    document.getElementById('addressUpdateSection').style.display = 'block';
                    document.getElementById('updateAddressInput').value = data.address; // Í∏∞Ï°¥ Ï£ºÏÜå ÌëúÏãú

                    // 2. ÏÉÅÌÉúÏóê Îî∞Îùº ÌôîÎ©¥ Î∂ÑÍ∏∞
                    if (data.status === 'granted' && data.oracle_message) {
                        // Ïã†ÌÉÅ ÎèÑÏ∞©
                        document.getElementById('waitingSection').style.display = 'none';
                        document.getElementById('grantedSection').style.display = 'block';
                        document.getElementById('oracleContent').innerText = data.oracle_message; // Î™®Îã¨Ïóê ÎÇ¥Ïö© Ï£ºÏûÖ
                    } else {
                        // ÎåÄÍ∏∞ Ï§ë
                        document.getElementById('waitingSection').style.display = 'block';
                        document.getElementById('grantedSection').style.display = 'none';
                    }
                } else {
                    // 3. Ï†úÏ∂ú Ïïà Ìï® -> Ìèº ÌëúÏãú
                    document.getElementById('formSection').style.display = 'block';
                }
            });
        }

        // üìù Ìèº Ï†úÏ∂ú (ÏµúÏ¥à 1Ìöå)
        window.submitForm = async function(e) {
            e.preventDefault();
            const btn = document.querySelector('.submit-btn');
            btn.innerText = "Offering...";
            btn.disabled = true;

            const formData = {
                birth_date: {
                    year: document.getElementById('birthYear').value,
                    month: document.getElementById('birthMonth').value,
                    day: document.getElementById('birthDay').value
                },
                birth_time: document.getElementById('birthTime').value,
                nationality: document.getElementById('nationality').value,
                sovereign_task: document.getElementById('sovereignTask').value,
                vision_2030: document.getElementById('vision').value,
                address: document.getElementById('address').value,
                status: 'pending', // Ï¥àÍ∏∞ ÏÉÅÌÉú
                timestamp: new Date().toISOString()
            };

            try {
                // Î¨∏ÏÑú IDÎ•º ÏÇ¨Ïö©Ïûê Ìï¥ÏãúÍ∞íÍ≥º ÎèôÏùºÌïòÍ≤å ÏÉùÏÑ± (1:1 Îß§Ïπ≠)
                await setDoc(doc(db, "oracle_requests", userHash), formData);
                // Ï†úÏ∂ú ÌõÑ ÌôîÎ©¥ÏùÄ onSnapshotÏù¥ Í∞êÏßÄÌï¥ÏÑú ÏûêÎèôÏúºÎ°ú Î∞îÍøà
            } catch (error) {
                console.error("Error:", error);
                alert("Connection Error. Please try again.");
                btn.innerText = "Offer to Equilibrium";
                btn.disabled = false;
            }
        };

        document.getElementById('oracleForm').addEventListener('submit', window.submitForm);

        // üè† Ï£ºÏÜå ÏàòÏ†ï Í∏∞Îä•
        window.updateAddress = async function() {
            const newAddr = document.getElementById('updateAddressInput').value;
            if(!newAddr) return alert("Please enter an address.");

            const confirmUpdate = confirm("Update your physical address?");
            if(confirmUpdate) {
                try {
                    const docRef = doc(db, "oracle_requests", userHash);
                    await updateDoc(docRef, { address: newAddr });
                    alert("Address Updated.");
                } catch(e) {
                    alert("Update Failed.");
                }
            }
        };

        // Î™®Îã¨ Ï†úÏñ¥
        window.openModal = function() {
            const modal = document.getElementById('oracleModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.style.opacity = 1, 10);
        }
        window.closeModal = function() {
            const modal = document.getElementById('oracleModal');
            modal.style.opacity = 0;
            setTimeout(() => modal.style.display = 'none', 500);
        }

        // ÎÇ†Ïßú ÏÑ†ÌÉùÍ∏∞ Ï¥àÍ∏∞Ìôî (Í∏∞Ï°¥ Î°úÏßÅ)
        function initDateSelects() {
            const yearSelect = document.getElementById('birthYear');
            const monthSelect = document.getElementById('birthMonth');
            const daySelect = document.getElementById('birthDay');
            
            for (let i = 2026; i >= 1900; i--) {
                let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; yearSelect.appendChild(opt);
            }
            for (let i = 1; i <= 12; i++) {
                let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; monthSelect.appendChild(opt);
            }
            
            function updateDays() {
                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);
                if (!year || !month) return;
                const lastDay = new Date(year, month, 0).getDate();
                daySelect.innerHTML = '<option value="" disabled selected>Day</option>';
                for (let i = 1; i <= lastDay; i++) {
                    let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; daySelect.appendChild(opt);
                }
            }
            yearSelect.onchange = updateDays;
            monthSelect.onchange = updateDays;
        }
    </script>
</body>
</html>
